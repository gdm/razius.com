<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Silviu Tantos (razius), Toying with the idea of becoming a useful member of society.">

        <link rel="alternate"  href="http://razius.com/feeds/all.atom.xml" type="application/atom+xml" title="Silviu Tantos (razius) Full Atom Feed"/>

        <title>Building a messaging framework forÂ Django</title>

        <link rel="stylesheet" href="http://razius.com/theme/css/style.min.css?abc8cdab">

        <script src="http://razius.com/theme/js/scripts.min.js?d41d8cd9"></script>
    <script src="http://razius.com/theme/js/jquery.fitvids.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
<div class="sidebar pure-u">
    <div class="cover-img" style="background-image: url('/images/cover.jpg')">
        <div class="cover-body">
            <header class="header">
                <hgroup>
                    <a href="/"><img class="avatar" src="http://www.gravatar.com/avatar/716ec647b64d8fc708a8494d1caeb5f7" height="72" width="72"></a>
                    <h1 class="brand-main"><a href="/">Silviu Tantos (razius)</a></h1>
                    <p class="tagline">Toying with the idea of becoming a useful member of society.</p>
                    <div class="pages-menu">
                        <p>
                            <span class="links pages"><a href="http://razius.com/">Home</a></span>
                                <span class="separator">&#x2022; </span><span class="links pages active"><a href="http://razius.com/pages/about/">About</a></span>
                                <span class="separator">&#x2022; </span><span class="links pages active"><a href="http://razius.com/pages/contact/">Contact</a></span>
                                <span class="separator">&#x2022; </span><span class="links pages active"><a href="http://razius.com/pages/cv/">CV</a></span>
                        </p>
                    </div>
                    <p class="social-links">
                            <a target="_blank" class="social Github" href="http://github.com/razius"><img src="http://razius.com/images/social/github.png" title="Github"></a>
                            <a target="_blank" class="social Last.fm" href="http://last.fm/user/razius"><img src="http://razius.com/images/social/last.fm.png" title="Last.fm"></a>
                            <a target="_blank" class="social Twitter" href="http://twitter.com/razius"><img src="http://razius.com/images/social/twitter.png" title="Twitter"></a>
                            <a target="_blank" class="social RSS" href="http://feeds.feedburner.com/razius"><img src="http://razius.com/images/social/rss.png" title="RSS"></a>
                    </p>
                </hgroup>
            </header>
        </div>
    </div>
</div>    <div class="pure-u-3-4">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Building a messaging framework for&nbsp;Django</h1>
                        <p class="post-meta">
                            meta = {'category': <a href="http://razius.com/category/tech/">tech</a>, 'date': 17-11-2013}
                            <div class="meta-tags">
                                tags = [<a class="post-category" href="http://razius.com/tag/django/">django</a><span class="comma">, </span><a class="post-category" href="http://razius.com/tag/iconfinder/">iconfinder</a><span class="comma">, </span><a class="post-category" href="http://razius.com/tag/messaging/">messaging</a><span class="comma">, </span><a class="post-category" href="http://razius.com/tag/redis/">redis</a><span class="comma">, </span>]
                            </div>
                        </p>
                </header>
            </section>
            <p>As you might have noticed, one of the key usability features that we were missing on Iconfinder was the ability to display so called &quot;flash messages.&quot; Flash messages are one-time notification messages shown to the user after processing a form or handling other types of user input, so the user knows if things went as expected. Changing your password without being told <em>Your password was updated.</em> can be a little confusing, so it was long overdue that we did something about something that&nbsp;obvious.</p>
<div class="figure align-center">
<img alt="messages" src="http://razius.com/images/articles/flash-messages.png" />
<p class="caption">Example of flash&nbsp;messages.</p>
</div>
<p class="italic">Note: This is a cross-post of <a class="reference external" href="http://blog.iconfinder.com/building-a-messaging-framework-for-django/">an article</a> that I originally wrote on my company&#8217;s blog a while&nbsp;back.</p>
<div class="section" id="context-is-king">
<h2>Context is&nbsp;king</h2>
<p>Most popular web frameworks already feature an easy drop-in way of showing these flash messages. Iconfinder is a heavy Django shop, and of course Django comes with its own <a class="reference external" href="https://docs.djangoproject.com/en/dev/ref/contrib/messages/">messaging framework</a> built in for just this purpose. But, like most other drop-in solutions, it rarely fits the bill of a larger&nbsp;site.</p>
<p>The built in messaging framework has a problem in that it&#8217;s not contextually bound - in other words, it&#8217;s not associated with any one form or page. This means, that messages from a specific form could under odd circumstances be shown in the completely wrong place, which is arguably more confusing than not being shown any message at&nbsp;all.</p>
<p>Furthermore, this also means that we can&#8217;t create &quot;out of band&quot; messages to be shown from asynchronous jobs, such as when we&#8217;re processing icon data, as that would just show up somewhere where the user might not expect it. What was left for us to do then, was to roll our own solution that would make it possible for us to do all the things we&nbsp;wanted.</p>
<p>Now, <em>contextual</em> is a pretty ambiguous term (which is why academics love using it) so we of course had to pick something more &quot;tangible.&quot; Django sites basically contain a bunch of views, which have the responsibility of displaying a specific kind of page, so as a starting place, we decided to bind messages to a specific view. As each user is also identified by a session, it made sense to start out with these two things defining the&nbsp;context.</p>
</div>
<div class="section" id="transient-messages-in-redis">
<h2>Transient messages in&nbsp;Redis</h2>
<p>Given the contextual nature of the messages, it is very likely that a user might have more than just one message waiting for him - especially if he or she is doing a lot of stuff at once. Therefore, the standard solution of using cookies to store the messages made no sense, as it would mean that a lot of pointless data was sent over the wire all the time. So, we have to store the data somewhere. Our primary PostgreSQL database is the first option, that comes to mind, but given that messages are shown once, that would mean that we&#8217;d be inserting and deleting a lot of data - something a relational database is usually not made for. Luckily, there are options out there that are basically made for this kind of workload, like for example our favorite key-value store, <a class="reference external" href="http://redis.io/">Redis</a>.</p>
<p>Redis is essentially in-memory, but we do snapshots every minute and run a master/slave pair to make sure we don&#8217;t loose too much data in case of failure, but the loss of a couple of messages won&#8217;t be the end of the world, which makes it the perfect tool for the&nbsp;job.</p>
<p>The beauty of Redis is, that we can get away with a simple key structure: the base key is the application name, followed by the session key and finally by a view identifier. This makes insertion and retrieval of values very easy. The keys are also set to expire after a default period of inactivity, just to make sure we don&#8217;t have any orphaned messages lying around a week after you&#8217;ve changed your&nbsp;password.</p>
<p><tt class="docutils literal"><span class="pre">messages:user-session-key:view-identifier</span></tt></p>
<p>When a new message needs to be shown, we simply serialize it along with a bit of meta data and store it in a <a class="reference external" href="http://redis.io/topics/data-types">sorted set</a> with the message&#8217;s timestamp as a score. This way the messages can be easily sorted by time or be purged using a garbage collection scheme if we run out of&nbsp;space.</p>
</div>
<div class="section" id="the-exposed-api">
<h2>The exposed&nbsp;<span class="caps">API</span></h2>
<p>One of the keys to keeping a large code base maintainable is to expose functionality through a stable, consistent <span class="caps">API</span>. The contextual messaging system adheres to this principle by exposing to simle methods: one to
add a message and the other one to retrieve all the messages for a session in a view. If you&#8217;re a Pythonista, the following should look familiar to&nbsp;you:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span class="kn">from</span> <span class="nn">messaging.models</span> <span class="kn">import</span> <span class="n">Message</span>

<span class="n">Message</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">session_key</span> <span class="o">=</span> <span class="s">&#39;current-users-session-key&#39;</span><span class="p">,</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;This *is* the message you are looking for.&#39;</span><span class="p">,</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Hello&#39;</span><span class="p">,</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n"><span class="caps">INFO</span></span><span class="p">,</span>
            <span class="n">autoclose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">my_view</span><span class="p">)</span>

<span class="n">messages</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_key</span> <span class="o">=</span> <span class="s">&#39;current-users-session-key&#39;</span><span class="p">,</span>
                       <span class="n">view</span> <span class="o">=</span> <span class="n">my_view</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="a-perfect-case-for-a-mixin">
<h2>A perfect case for a&nbsp;mixin</h2>
<p>Django provides <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/class-based-views/">class based views</a> which makes it easy to structure views and expose common functionality by harnessing inheritance and mixins. Because in most of the cases we would need to add and retrieve messages for the current view, to make it even easier we created a mixin that would provide some abstracted functionality to our view classes. The retrieval of messages for the current view is handled by the mixin so messages are ready to be consumed in the templates without having to call <tt class="docutils literal">Message.get()</tt> in each&nbsp;view.</p>
<p>Adding a message is also a lot easier as we can figure out the view name and session from the&nbsp;view:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span class="k">class</span> <span class="nc">DashboardView</span><span class="p">(</span><span class="n">MessageViewMixin</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="s">&#39;Your settings have been changed successfully.&#39;</span><span class="p">,</span>
                         <span class="n">status</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n"><span class="caps">SUCCESS</span></span><span class="p">)</span>
</pre></div>
</td></tr></table><p>Doesn&#8217;t get much easier than that,&nbsp;huh?</p>
</div>
<div class="section" id="don-t-be-afraid-to-write-code">
<h2>Don&#8217;t be afraid to write&nbsp;code</h2>
<p>If there is a functionality built into the framework that you need but it doesn&#8217;t fit you use case, don&#8217;t be afraid to write your own solution. In most cases you only need a minimum viable product that fits your needs really well rather than a full fledged library that can send a rocket to the&nbsp;moon.</p>
</div>

            <div class="hr"></div>
            <a href="#" class="go-top">Go Top</a>
                <div class="comments">
                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        var disqus_identifier = "articles/building-a-messaging-framework-for-django/";
                        var disqus_url = "http://razius.com/articles/building-a-messaging-framework-for-django/";
                        (function() {
                            var dsq = document.createElement('script');
                            dsq.type = 'text/javascript';
                            dsq.async = true;
                            dsq.src = 'http://razius.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view <a href="http://disqus.com/?ref_noscript">comments</a>.</noscript>
                </div>
<footer class="footer">
    <p>Powered by <a href="http://blog.getpelican.com/">Pelican</a> with a modified theme based on <a href="https://github.com/danclaudiupop/pure">Pure</a>.
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
            var pageTracker = _gat._getTracker("UA-29024708-1");
            pageTracker._trackPageview();
            } catch(err) {}
    </script>
</body>
</html>